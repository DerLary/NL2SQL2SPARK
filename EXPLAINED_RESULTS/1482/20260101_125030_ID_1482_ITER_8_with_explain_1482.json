{
    "query_id": 1482,
    "difficulty": "challenging",
    "is_initial": true,
    "nl_query": "Which of the three segments\u2014SME, LAM and KAM\u2014has the biggest and lowest percentage increases in consumption paid in EUR between 2012 and 2013? Increase or Decrease = consumption for 2013 - consumption for 2012; Percentage of Increase = (Increase or Decrease / consumption for 2013) * 100%; The first 4 strings of the Date values in the yearmonth table can represent year",
    "golden_query": "SELECT CAST((SUM(IF(T1.Segment = 'SME' AND T2.Date LIKE '2013%', T2.Consumption, 0)) - SUM(IF(T1.Segment = 'SME' AND T2.Date LIKE '2012%', T2.Consumption, 0))) AS FLOAT) * 100 / SUM(IF(T1.Segment = 'SME' AND T2.Date LIKE '2012%', T2.Consumption, 0)), CAST(SUM(IF(T1.Segment = 'LAM' AND T2.Date LIKE '2013%', T2.Consumption, 0)) - SUM(IF(T1.Segment = 'LAM' AND T2.Date LIKE '2012%', T2.Consumption, 0)) AS FLOAT) * 100 / SUM(IF(T1.Segment = 'LAM' AND T2.Date LIKE '2012%', T2.Consumption, 0)), CAST(SUM(IF(T1.Segment = 'KAM' AND T2.Date LIKE '2013%', T2.Consumption, 0)) - SUM(IF(T1.Segment = 'KAM' AND T2.Date LIKE '2012%', T2.Consumption, 0)) AS FLOAT) * 100 / SUM(IF(T1.Segment = 'KAM' AND T2.Date LIKE '2012%', T2.Consumption, 0)) FROM customers AS T1 INNER JOIN yearmonth AS T2 ON T1.CustomerID = T2.CustomerID",
    "sparksql_query": "WITH ConsumptionByYear AS (SELECT c.`Segment`, YEAR(t.`Date`) AS `Year`, SUM(t.`Price`) AS `TotalConsumption` FROM `customers` c JOIN `transactions_1k` t ON c.`CustomerID` = t.`CustomerID` WHERE c.`Currency` = 'EUR' AND YEAR(t.`Date`) IN (2012, 2013) GROUP BY c.`Segment`, YEAR(t.`Date`)), SegmentConsumption AS (SELECT `Segment`, SUM(CASE WHEN `Year` = 2012 THEN `TotalConsumption` ELSE 0 END) AS `Consumption2012`, SUM(CASE WHEN `Year` = 2013 THEN `TotalConsumption` ELSE 0 END) AS `Consumption2013` FROM ConsumptionByYear GROUP BY `Segment`) SELECT `Segment`, `Consumption2012`, `Consumption2013`, (`Consumption2013` - `Consumption2012`) AS `IncreaseDecrease`, ( CAST((`Consumption2013` - `Consumption2012`) AS DOUBLE) / NULLIF(`Consumption2013`, 0) ) * 100 AS `PercentageIncrease` FROM SegmentConsumption ORDER BY `PercentageIncrease` DESC;",
    "jaccard_index": null,
    "exact_match": null,
    "ground_truth": null,
    "query_result": null,
    "execution_plans": {
        "golden_query": "\nExecution Plan for: Golden Query ID 1482...\n================================================================================\n\n1. Logical plan:\n----------------------------------------\n'Project [unresolvedalias(((cast(('SUM('IF((('T1.Segment = SME) AND 'T2.Date LIKE 2013%), 'T2.Consumption, 0)) - 'SUM('IF((('T1.Segment = SME) AND 'T2.Date LIKE 2012%), 'T2.Consumption, 0))) as float) * 100) / 'SUM('IF((('T1.Segment = SME) AND 'T2.Date LIKE 2012%), 'T2.Consumption, 0)))), unresolvedalias(((cast(('SUM('IF((('T1.Segment = LAM) AND 'T2.Date LIKE 2013%), 'T2.Consumption, 0)) - 'SUM('IF((('T1.Segment = LAM) AND 'T2.Date LIKE 2012%), 'T2.Consumption, 0))) as float) * 100) / 'SUM('IF((('T1.Segment = LAM) AND 'T2.Date LIKE 2012%), 'T2.Consumption, 0)))), unresolvedalias(((cast(('SUM('IF((('T1.Segment = KAM) AND 'T2.Date LIKE 2013%), 'T2.Consumption, 0)) - 'SUM('IF((('T1.Segment = KAM) AND 'T2.Date LIKE 2012%), 'T2.Consumption, 0))) as float) * 100) / 'SUM('IF((('T1.Segment = KAM) AND 'T2.Date LIKE 2012%), 'T2.Consumption, 0))))]\n+- 'Join Inner, ('T1.CustomerID = 'T2.CustomerID)\n   :- 'SubqueryAlias T1\n   :  +- 'UnresolvedRelation [customers], [], false\n   +- 'SubqueryAlias T2\n      +- 'UnresolvedRelation [yearmonth], [], false\n\n\n2. Optimized logical plan (After Catalyst AFAIK):\n----------------------------------------\nAggregate [((cast(cast((sum(if (((Segment#28845 = SME) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0) - sum(if (((Segment#28845 = SME) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0)) as float) as double) * 100.0) / sum(if (((Segment#28845 = SME) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0)) AS ((CAST((sum((IF(((Segment = SME) AND Date LIKE 2013%), Consumption, 0))) - sum((IF(((Segment = SME) AND Date LIKE 2012%), Consumption, 0)))) AS FLOAT) * 100) / sum((IF(((Segment = SME) AND Date LIKE 2012%), Consumption, 0))))#28876, ((cast(cast((sum(if (((Segment#28845 = LAM) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0) - sum(if (((Segment#28845 = LAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0)) as float) as double) * 100.0) / sum(if (((Segment#28845 = LAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0)) AS ((CAST((sum((IF(((Segment = LAM) AND Date LIKE 2013%), Consumption, 0))) - sum((IF(((Segment = LAM) AND Date LIKE 2012%), Consumption, 0)))) AS FLOAT) * 100) / sum((IF(((Segment = LAM) AND Date LIKE 2012%), Consumption, 0))))#28877, ((cast(cast((sum(if (((Segment#28845 = KAM) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0) - sum(if (((Segment#28845 = KAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0)) as float) as double) * 100.0) / sum(if (((Segment#28845 = KAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0)) AS ((CAST((sum((IF(((Segment = KAM) AND Date LIKE 2013%), Consumption, 0))) - sum((IF(((Segment = KAM) AND Date LIKE 2012%), Consumption, 0)))) AS FLOAT) * 100) / sum((IF(((Segment = KAM) AND Date LIKE 2012%), Consumption, 0))))#28878]\n+- Project [Segment#28845, Date#28865, Consumption#28866]\n   +- Join Inner, (CustomerID#28844 = CustomerID#28864)\n      :- Project [CustomerID#28844, Segment#28845]\n      :  +- Filter isnotnull(CustomerID#28844)\n      :     +- Relation [CustomerID#28844,Segment#28845,Currency#28846] JDBCRelation((SELECT \"CustomerID\", \"Segment\", \"Currency\" FROM \"customers\") AS \"customers\") [numPartitions=1]\n      +- Filter isnotnull(CustomerID#28864)\n         +- Relation [CustomerID#28864,Date#28865,Consumption#28866] JDBCRelation((SELECT \"CustomerID\", \"Date\", \"Consumption\" FROM \"yearmonth\") AS \"yearmonth\") [numPartitions=1]\n\n\n3. Physical plan:\n----------------------------------------\nAdaptiveSparkPlan isFinalPlan=false\n+- HashAggregate(keys=[], functions=[sum(if (((Segment#28845 = SME) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), sum(if (((Segment#28845 = SME) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0), sum(if (((Segment#28845 = LAM) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), sum(if (((Segment#28845 = LAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0), sum(if (((Segment#28845 = KAM) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), sum(if (((Segment#28845 = KAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0)], output=[((CAST((sum((IF(((Segment = SME) AND Date LIKE 2013%), Consumption, 0))) - sum((IF(((Segment = SME) AND Date LIKE 2012%), Consumption, 0)))) AS FLOAT) * 100) / sum((IF(((Segment = SME) AND Date LIKE 2012%), Consumption, 0))))#28876, ((CAST((sum((IF(((Segment = LAM) AND Date LIKE 2013%), Consumption, 0))) - sum((IF(((Segment = LAM) AND Date LIKE 2012%), Consumption, 0)))) AS FLOAT) * 100) / sum((IF(((Segment = LAM) AND Date LIKE 2012%), Consumption, 0))))#28877, ((CAST((sum((IF(((Segment = KAM) AND Date LIKE 2013%), Consumption, 0))) - sum((IF(((Segment = KAM) AND Date LIKE 2012%), Consumption, 0)))) AS FLOAT) * 100) / sum((IF(((Segment = KAM) AND Date LIKE 2012%), Consumption, 0))))#28878])\n  +- Exchange SinglePartition, ENSURE_REQUIREMENTS, [plan_id=47546]\n      +- HashAggregate(keys=[], functions=[partial_sum(if (((Segment#28845 = SME) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), partial_sum(if (((Segment#28845 = SME) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0), partial_sum(if (((Segment#28845 = LAM) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), partial_sum(if (((Segment#28845 = LAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0), partial_sum(if (((Segment#28845 = KAM) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), partial_sum(if (((Segment#28845 = KAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0)], output=[sum#28885, sum#28886, sum#28887, sum#28888, sum#28889, sum#28890])\n        +- Project [Segment#28845, Date#28865, Consumption#28866]\n            +- SortMergeJoin [CustomerID#28844], [CustomerID#28864], Inner\n              :- Sort [CustomerID#28844 ASC NULLS FIRST], false, 0\n              :  +- Exchange hashpartitioning(CustomerID#28844, 200), ENSURE_REQUIREMENTS, [plan_id=47538]\n              :     +- Scan JDBCRelation((SELECT \"CustomerID\", \"Segment\", \"Currency\" FROM \"customers\") AS \"customers\") [numPartitions=1] [CustomerID#28844,Segment#28845] PushedFilters: [*IsNotNull(CustomerID)], ReadSchema: struct<CustomerID:int,Segment:string>\n              +- Sort [CustomerID#28864 ASC NULLS FIRST], false, 0\n                  +- Exchange hashpartitioning(CustomerID#28864, 200), ENSURE_REQUIREMENTS, [plan_id=47539]\n                    +- Scan JDBCRelation((SELECT \"CustomerID\", \"Date\", \"Consumption\" FROM \"yearmonth\") AS \"yearmonth\") [numPartitions=1] [CustomerID#28864,Date#28865,Consumption#28866] PushedFilters: [*IsNotNull(CustomerID)], ReadSchema: struct<CustomerID:int,Date:string,Consumption:double>\n\n4. Explain output:\n----------------------------------------\n\nPhysical Plan ==:\n-----------------\n  AdaptiveSparkPlan isFinalPlan=false\n  +- HashAggregate(keys=[], functions=[sum(if (((Segment#28845 = SME) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), sum(if (((Segment#28845 = SME) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0), sum(if (((Segment#28845 = LAM) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), sum(if (((Segment#28845 = LAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0), sum(if (((Segment#28845 = KAM) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), sum(if (((Segment#28845 = KAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0)])\n  +- Exchange SinglePartition, ENSURE_REQUIREMENTS, [plan_id=47583]\n  +- HashAggregate(keys=[], functions=[partial_sum(if (((Segment#28845 = SME) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), partial_sum(if (((Segment#28845 = SME) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0), partial_sum(if (((Segment#28845 = LAM) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), partial_sum(if (((Segment#28845 = LAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0), partial_sum(if (((Segment#28845 = KAM) AND StartsWith(Date#28865, 2013))) Consumption#28866 else 0.0), partial_sum(if (((Segment#28845 = KAM) AND StartsWith(Date#28865, 2012))) Consumption#28866 else 0.0)])\n  +- Project [Segment#28845, Date#28865, Consumption#28866]\n  +- SortMergeJoin [CustomerID#28844], [CustomerID#28864], Inner\n  :- Sort [CustomerID#28844 ASC NULLS FIRST], false, 0\n  :  +- Exchange hashpartitioning(CustomerID#28844, 200), ENSURE_REQUIREMENTS, [plan_id=47575]\n  :     +- Scan JDBCRelation((SELECT \"CustomerID\", \"Segment\", \"Currency\" FROM \"customers\") AS \"customers\") [numPartitions=1] [CustomerID#28844,Segment#28845] PushedFilters: [*IsNotNull(CustomerID)], ReadSchema: struct<CustomerID:int,Segment:string>\n  +- Sort [CustomerID#28864 ASC NULLS FIRST], false, 0\n  +- Exchange hashpartitioning(CustomerID#28864, 200), ENSURE_REQUIREMENTS, [plan_id=47576]\n  +- Scan JDBCRelation((SELECT \"CustomerID\", \"Date\", \"Consumption\" FROM \"yearmonth\") AS \"yearmonth\") [numPartitions=1] [CustomerID#28864,Date#28865,Consumption#28866] PushedFilters: [*IsNotNull(CustomerID)], ReadSchema: struct<CustomerID:int,Date:string,Consumption:double>\n================================================================================",
        "model_query": "\nExecution Plan for: Model Query ID 1482...\n================================================================================\nCould not create DataFrame for the query: [DATATYPE_MISMATCH.UNEXPECTED_INPUT_TYPE] Cannot resolve \"year(Date)\" due to data type mismatch: The first parameter requires the \"DATE\" type, however \"Date\" has the type \"DECIMAL(38,18)\". SQLSTATE: 42K09; line 1 pos 220;\n'Sort ['PercentageIncrease DESC NULLS LAST], true\n+- 'Project ['Segment, 'Consumption2012, 'Consumption2013, ('Consumption2013 - 'Consumption2012) AS IncreaseDecrease#28919, ((cast(('Consumption2013 - 'Consumption2012) as double) / 'NULLIF('Consumption2013, 0)) * 100) AS PercentageIncrease#28920]\n   +- 'SubqueryAlias SegmentConsumption\n      +- 'SubqueryAlias SegmentConsumption\n         +- 'Aggregate ['Segment], ['Segment, 'SUM(CASE WHEN ('Year = 2012) THEN 'TotalConsumption ELSE 0 END) AS Consumption2012#28923, 'SUM(CASE WHEN ('Year = 2013) THEN 'TotalConsumption ELSE 0 END) AS Consumption2013#28924]\n            +- 'SubqueryAlias ConsumptionByYear\n               +- 'SubqueryAlias ConsumptionByYear\n                  +- 'Aggregate ['c.Segment, 'YEAR('t.Date)], ['c.Segment, 'YEAR('t.Date) AS Year#28921, 'SUM('t.Price) AS TotalConsumption#28922]\n                     +- 'Filter ((Currency#28846 = EUR) AND year(Date#28854) IN (2012,2013))\n                        +- Join Inner, (CustomerID#28844 = CustomerID#28856)\n                           :- SubqueryAlias c\n                           :  +- SubqueryAlias customers\n                           :     +- View (`customers`, [CustomerID#28844, Segment#28845, Currency#28846])\n                           :        +- Relation [CustomerID#28844,Segment#28845,Currency#28846] JDBCRelation((SELECT \"CustomerID\", \"Segment\", \"Currency\" FROM \"customers\") AS \"customers\") [numPartitions=1]\n                           +- SubqueryAlias t\n                              +- SubqueryAlias transactions_1k\n                                 +- View (`transactions_1k`, [TransactionID#28853, Date#28854, Time#28855, CustomerID#28856, CardID#28857, GasStationID#28858, ProductID#28859, Amount#28860, Price#28861])\n                                    +- Relation [TransactionID#28853,Date#28854,Time#28855,CustomerID#28856,CardID#28857,GasStationID#28858,ProductID#28859,Amount#28860,Price#28861] JDBCRelation((SELECT \"TransactionID\", CAST(\"Date\" AS TEXT) AS \"Date\", \"Time\", \"CustomerID\", \"CardID\", \"GasStationID\", \"ProductID\", \"Amount\", \"Price\" FROM \"transactions_1k\") AS \"transactions_1k\") [numPartitions=1]\n"
    },
    "result_file_path": "/home/lars/Privat/RWTH/Auslandssemester/#KURSE/Safe Distributed Systems/Exercises/Practical_Exercise/NL2SQL2SPARK/RAW_RESULTS/benchmark_results_20260101_google_ce2b3070/1482/20260101_125030_ID_1482_ITER_8_559a5676.json",
    "explainer_metrics": {
        "golden_query": {
            "shuffle_count": {
                "Exchange\\s+hashpartitioning\\(": 2,
                "Exchange\\s+rangepartitioning\\(": 0,
                "Exchange\\s+SinglePartition": 1,
                "ShuffleExchange": 0,
                "TOTAL": 3
            },
            "has_broadcast_join": false,
            "has_predicate_pushdown": true,
            "pushed_filters": [
                {
                    "scan_line": ":     +- Scan JDBCRelation((SELECT \"CustomerID\", \"Segment\", \"Currency\" FROM \"customers\") AS \"customers\") [numPartitions=1] [CustomerID#28844,Segment#28845] PushedFilters: [*IsNotNull(CustomerID)], ReadSchema: struct<CustomerID:int,Segment:string>",
                    "filters": [
                        "*IsNotNull(CustomerID)"
                    ]
                },
                {
                    "scan_line": "+- Scan JDBCRelation((SELECT \"CustomerID\", \"Date\", \"Consumption\" FROM \"yearmonth\") AS \"yearmonth\") [numPartitions=1] [CustomerID#28864,Date#28865,Consumption#28866] PushedFilters: [*IsNotNull(CustomerID)], ReadSchema: struct<CustomerID:int,Date:string,Consumption:double>",
                    "filters": [
                        "*IsNotNull(CustomerID)"
                    ]
                },
                {
                    "scan_line": ":     +- Scan JDBCRelation((SELECT \"CustomerID\", \"Segment\", \"Currency\" FROM \"customers\") AS \"customers\") [numPartitions=1] [CustomerID#28844,Segment#28845] PushedFilters: [*IsNotNull(CustomerID)], ReadSchema: struct<CustomerID:int,Segment:string>",
                    "filters": [
                        "*IsNotNull(CustomerID)"
                    ]
                },
                {
                    "scan_line": "+- Scan JDBCRelation((SELECT \"CustomerID\", \"Date\", \"Consumption\" FROM \"yearmonth\") AS \"yearmonth\") [numPartitions=1] [CustomerID#28864,Date#28865,Consumption#28866] PushedFilters: [*IsNotNull(CustomerID)], ReadSchema: struct<CustomerID:int,Date:string,Consumption:double>",
                    "filters": [
                        "*IsNotNull(CustomerID)"
                    ]
                }
            ],
            "filter_count_before_optimization": 0,
            "filter_count_after_optimization": 2
        },
        "model_query": {
            "shuffle_count": 0,
            "has_broadcast_join": false,
            "has_predicate_pushdown": false,
            "pushed_filters": [],
            "filter_count_before_optimization": 0,
            "filter_count_after_optimization": 0
        },
        "plan_equivalence": {
            "golden_vs_model_physical_equivalent": false
        }
    }
}